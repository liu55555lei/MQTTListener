<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消息查询</title>
    <style>
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif; margin: 16px; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .field { display: flex; flex-direction: column; gap: 6px; }
        .field label { font-size: 12px; color: #374151; }
        input, select, textarea { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        textarea { min-height: 60px; width: 360px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background: #f9fafb; }
        .actions { display: flex; gap: 8px; }
        .btn { padding: 8px 12px; border: 1px solid #d1d5db; background: #fff; border-radius: 6px; cursor: pointer; }
        .btn.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
        .btn.link { background: transparent; border: none; color: #2563eb; cursor: pointer; }
        .pagination { display: flex; gap: 8px; align-items: center; }
        .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); }
        .modal .panel { background: #fff; width: min(900px, 92vw); max-height: 90vh; overflow: auto; border-radius: 8px; padding: 12px; }
        code { white-space: pre-wrap; word-break: break-word; }
        /* Loading overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .loading-overlay .box { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 20px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .spinner { width: 32px; height: 32px; border: 3px solid #d1d5db; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="card">
    <div class="row">
        <div class="field">
            <label>通道名称</label>
            <input id="channelInput" list="channelList" placeholder="输入关键字进行模糊搜索" />
            <datalist id="channelList"></datalist>
        </div>
        <div class="field">
            <label>开始时间</label>
            <input id="startTime" type="datetime-local" />
        </div>
        <div class="field">
            <label>结束时间</label>
            <input id="endTime" type="datetime-local" />
        </div>
        <div class="field">
            <label>分页条数</label>
            <select id="pageSize">
                <option value="20">20</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
            </select>
        </div>
        <div class="field" style="margin-top: 20px;">
            <label>&nbsp;</label>
            <label style="display:flex; align-items:center; gap:6px;">
                <input id="latestOnly" type="checkbox" /> 只看最新数据
            </label>
        </div>
    </div>
    <div class="row" style="margin-top:12px; align-items: flex-start;">
        <div class="field">
            <label>标识信息（多行或用、分隔）</label>
            <textarea id="identifiers" placeholder="每行一个，或用中文、分隔"></textarea>
        </div>
        <div class="actions" style="margin-top:22px;">
            <button class="btn primary" onclick="query(1)">查询</button>
            <button class="btn" onclick="resetForm()">重置</button>
        </div>
    </div>
</div>

<div class="card">
    <table>
        <thead>
        <tr>
            <th>通道名称</th>
            <th>标识值</th>
            <th>接收时间</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
    <div class="row" style="margin-top:12px; justify-content: space-between;">
        <div class="pagination">
            <button class="btn" onclick="prevPage()">上一页</button>
            <span>第 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页，共 <span id="totalCount">0</span> 条</span>
            <button class="btn" onclick="nextPage()">下一页</button>
        </div>
        <div class="pagination">
            <span>跳转到</span>
            <input id="jumpInput" type="number" min="1" style="width:80px;"/>
            <button class="btn" onclick="jumpTo()">跳转</button>
        </div>
    </div>
    <div style="margin-top:6px; color:#6b7280; font-size:12px;">提示：为保证性能，单次最多返回500条，可调整分页条数。</div>
</div>

<div class="modal" id="detailModal" onclick="if(event.target.id==='detailModal'){closeDetail()}">
    <div class="panel">
        <div class="row" style="justify-content: space-between;">
            <strong>消息明细</strong>
            <button class="btn" onclick="closeDetail()">关闭</button>
        </div>
        <pre><code id="detailContent"></code></pre>
    </div>
    </div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="box">
        <div class="spinner"></div>
        <div style="color:#374151; font-size:14px;">正在查询，请稍候...</div>
    </div>
}</div>

<script>
    // 使用 BigInt 安全处理ID，向后端传参与展示均使用字符串
    let state = { page: 1, size: 50, pages: 1 };

    function setLoading(flag) {
        const el = document.getElementById('loadingOverlay');
        if (!el) return;
        el.style.display = flag ? 'flex' : 'none';
    }

    function iso(dtLocal) {
        if (!dtLocal) return '';
        // datetime-local 为本地时间，无时区信息，构造本地时间，再转ISO
        const d = new Date(dtLocal.replace(' ', 'T'));
        // 转换为 ISO 字符串（去掉毫秒，统一格式）
        return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,19);
    }

    async function query(page) {
        if (page !== undefined) state.page = Number(page);
        state.size = Number(document.getElementById('pageSize').value) || 50;
        const channel = document.getElementById('channelInput').value.trim();
        const start = iso(document.getElementById('startTime').value);
        const end = iso(document.getElementById('endTime').value);
        const identifiers = document.getElementById('identifiers').value;
        const latestOnly = document.getElementById('latestOnly').checked;

        const params = new URLSearchParams();
        if (channel) params.append('channelName', channel);
        if (identifiers) params.append('identifiers', identifiers);
        if (start) params.append('startTime', start);
        if (end) params.append('endTime', end);
        params.append('page', String(state.page));
        params.append('size', String(state.size));
        if (latestOnly) params.append('latestOnly', 'true');

        setLoading(true);
        try {
            const res = await fetch('/api/message/page?' + params.toString());
            const body = await res.json();
            if (body.code !== 200) { alert(body.msg || '请求失败'); return; }
            const data = body.data;
            state.pages = Number(data.pages) || 1;
            state.page = Number(data.current) || 1;
            document.getElementById('currentPage').innerText = state.page;
            document.getElementById('totalPages').innerText = data.pages || 1;
            document.getElementById('totalCount').innerText = data.total || 0;

            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';
            (data.records || []).forEach(row => {
                const tr = document.createElement('tr');
                const idStr = String(row.id);
                tr.innerHTML = `
                    <td>${escapeHtml(row.channelName || '')}</td>
                    <td>${escapeHtml(row.identifierValue || '')}</td>
                    <td>${escapeHtml((row.receiveTime || '').replace('T',' '))}</td>
                    <td><button class="btn link" onclick="showDetail('${idStr}')">查看明细</button></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            alert('请求失败');
        } finally {
            setLoading(false);
        }
    }

    async function showDetail(idStr) {
        const res = await fetch('/api/message/detail?id=' + encodeURIComponent(idStr));
        const body = await res.json();
        if (body.code !== 200) { alert(body.msg || '获取明细失败'); return; }
        let content = '';
        try {
            const parsed = JSON.parse(body.data.jsonContent);
            content = JSON.stringify(parsed, null, 2);
        } catch (e) {
            content = body.data.jsonContent;
        }
        document.getElementById('detailContent').textContent = content;
        document.getElementById('detailModal').style.display = 'flex';
    }

    function closeDetail() { document.getElementById('detailModal').style.display = 'none'; }

    function prevPage() { if (Number(state.page) > 1) query(Number(state.page) - 1); }
    function nextPage() { if (Number(state.page) < Number(state.pages)) query(Number(state.page) + 1); }
    function jumpTo() {
        const v = Number(document.getElementById('jumpInput').value);
        if (!v || v < 1) return;
        const page = Math.min(Math.max(1, v), state.pages || 1);
        query(page);
    }

    function resetForm() {
        document.getElementById('channelInput').value = '';
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('pageSize').value = '50';
        document.getElementById('identifiers').value = '';
        document.getElementById('latestOnly').checked = false;
        state.page = 1; state.size = 50; state.pages = 1;
        document.getElementById('tbody').innerHTML = '';
        document.getElementById('currentPage').innerText = '1';
        document.getElementById('totalPages').innerText = '1';
        document.getElementById('totalCount').innerText = '0';
    }

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    async function refreshChannelList() {
        const keyword = document.getElementById('channelInput').value.trim();
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        const res = await fetch('/api/message/channels?' + params.toString());
        const body = await res.json();
        if (body.code !== 200) return;
        const list = body.data || [];
        const dl = document.getElementById('channelList');
        dl.innerHTML = '';
        list.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            dl.appendChild(opt);
        });
    }

    let channelDebounce;
    document.getElementById('channelInput').addEventListener('input', () => {
        clearTimeout(channelDebounce);
        channelDebounce = setTimeout(refreshChannelList, 300);
    });

    // 初次加载
    refreshChannelList();
    query(1);
</script>
</body>
</html>


